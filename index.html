<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nick Game Items - Admin Pro</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        :root { --primary: #00d2ff; --accent: #ff007b; --bg: #0a0a0c; --card: rgba(255, 255, 255, 0.08); --success: #00ff88; --danger: #ff4757; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: #eee; margin: 0; padding-bottom: 90px; }
        .container { max-width: 450px; margin: auto; padding: 15px; }
        .hidden { display: none !important; }
        .card { background: var(--card); border-radius: 12px; padding: 15px; border: 1px solid rgba(255,255,255,0.1); margin-bottom: 12px; backdrop-filter: blur(10px); }
        input, select { width: 100%; padding: 10px; margin: 5px 0; border-radius: 8px; background: #1a1a1a; color: white; border: 1px solid #333; }
        .btn { width: 100%; padding: 10px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; margin-top: 5px; font-size: 0.8rem; }
        .btn-wallet { background: var(--primary); color: #000; }
        .btn-direct { background: var(--accent); color: #fff; }
        .btn-success { background: var(--success); color: #000; }
        .top-bar { background: rgba(0,0,0,0.9); padding: 15px; display: flex; justify-content: space-between; position: sticky; top: 0; z-index: 100; border-bottom: 1px solid var(--primary); }
        .section-title { font-size: 0.85rem; color: var(--primary); margin: 15px 0 8px; border-left: 3px solid var(--accent); padding-left: 10px; font-weight: bold; }
        .price-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .price-item { background: rgba(255,255,255,0.03); padding: 10px 5px; border-radius: 8px; text-align: center; border: 1px solid #333; cursor: pointer; font-size: 0.7rem; position: relative; }
        .price-item.selected { border-color: var(--accent); background: rgba(255,0,123,0.1); }
        .bottom-nav { position: fixed; bottom: 0; width: 100%; max-width: 450px; background: #111; display: flex; justify-content: space-around; padding: 10px 0; border-top: 1px solid #333; }
        .nav-item { text-align: center; color: #777; font-size: 0.7rem; cursor: pointer; flex: 1; }
        .nav-item.active { color: var(--primary); }
        .chat-box { height: 250px; overflow-y: auto; background: #000; border-radius: 10px; padding: 10px; display: flex; flex-direction: column; gap: 8px; margin-bottom: 10px; }
        .msg { padding: 8px 12px; border-radius: 12px; max-width: 80%; font-size: 0.8rem; }
        .msg.sent { align-self: flex-end; background: var(--primary); color: #000; }
        .msg.received { align-self: flex-start; background: #333; color: #fff; }
        .badge { background: var(--accent); color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.6rem; float: right; }
    </style>
</head>
<body>

<div id="app">
    <div id="topNav" class="top-bar hidden">
        <div><small id="userLabel"></small><br><b>üí∞ <span id="uBal">0</span> MMK</b></div>
        <button onclick="logout()" style="background:none; color:red; border:1px solid red; padding:4px 8px; border-radius:5px; font-size:0.7rem;">Logout</button>
    </div>

    <div class="container">
        <div id="authPanel">
            <h1 style="text-align:center; color:var(--primary);">üíé Nick Game</h1>
            <div id="loginView" class="card">
                <input type="text" id="lUser" placeholder="Username">
                <input type="password" id="lPass" placeholder="Password">
                <button class="btn btn-wallet" onclick="handleLogin()">LOGIN</button>
                <p onclick="toggleAuth(true)" style="text-align:center; cursor:pointer;"><small>·Ä°·ÄÄ·Ä±·Ä¨·ÄÑ·Ä∑·Ä∫·Äû·ÄÖ·Ä∫·Äñ·ÄΩ·ÄÑ·Ä∑·Ä∫·Äõ·Äî·Ä∫</small></p>
            </div>
            <div id="signView" class="card hidden">
                <input type="text" id="sUser" placeholder="Username">
                <input type="password" id="sPass" placeholder="Password">
                <button class="btn btn-direct" onclick="handleSignUp()">REGISTER</button>
                <p onclick="toggleAuth(false)" style="text-align:center; cursor:pointer;"><small>Login ·Äï·Äº·Äî·Ä∫·Äù·ÄÑ·Ä∫·Äõ·Äî·Ä∫</small></p>
            </div>
        </div>

        <div id="adminPage" class="hidden">
            <h2 style="color:var(--primary); text-align:center;">Admin Master Panel</h2>
            
            <div class="section-title">üí∏ Pending Deposits (·ÄÑ·ÄΩ·Ä±·Äñ·Äº·Ää·Ä∑·Ä∫·Äú·ÄΩ·Äæ·Ä¨·Äô·Äª·Ä¨·Ä∏)</div>
            <div id="admDeposits"></div>

            <div class="section-title">üì¶ New Orders (·Ä°·Ä±·Ä¨·Ä∫·Äí·Ä´·Äô·Äª·Ä¨·Ä∏)</div>
            <div id="admOrders"></div>

            <div class="section-title">üí¨ User Chats (·Äô·ÄÄ·Ä∫·ÄÜ·Ä±·Ä∑·ÄÅ·Ä∫·Äª·Äô·Äª·Ä¨·Ä∏)</div>
            <div id="admChatList"></div>
            <div id="admChatView" class="card hidden">
                <button onclick="closeAdminChat()" style="float:right; background:none; border:none; color:red;">Close</button>
                <h4 id="targetChatUser"></h4>
                <div id="admChatBox" class="chat-box"></div>
                <div style="display:flex; gap:5px;">
                    <input type="text" id="admChatInput" placeholder="·ÄÖ·Ä¨·Äï·Äº·Äî·Ä∫·Äõ·Äî·Ä∫...">
                    <button class="btn btn-wallet" style="width:70px;" onclick="sendAdminChat()">Send</button>
                </div>
            </div>

            <div class="section-title">‚ûï Add Products</div>
            <div class="card">
                <select id="admCat">
                    <option value="weekly">ML Weekly</option>
                    <option value="normal">ML Dia</option>
                    <option value="uc_normal">PUBG UC</option>
                </select>
                <input type="text" id="admItemName" placeholder="Name">
                <input type="number" id="admItemPrice" placeholder="Price">
                <button class="btn btn-success" onclick="saveItem()">Save</button>
            </div>
        </div>

        <div id="shopPage" class="hidden">
            <div class="section-title">MLBB Items</div><div class="price-grid" id="gridWeekly"></div><div class="price-grid" id="gridNormal"></div>
            <div class="section-title">PUBG UC</div><div class="price-grid" id="gridUc_normal"></div>
            
            <div class="card" style="margin-top:20px;">
                <h4 id="selText">·Äï·ÄÖ·Äπ·ÄÖ·Ää·Ä∫·Ä∏·Äõ·ÄΩ·Ä±·Ä∏·Äï·Ä´</h4>
                <input type="text" id="gameId" placeholder="Game ID / Player ID">
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-direct" onclick="submitOrder('direct')">·Äê·Ä≠·ÄØ·ÄÄ·Ä∫·Äõ·Ä≠·ÄØ·ÄÄ·Ä∫·Äù·Äö·Ä∫</button>
                    <button class="btn btn-wallet" onclick="submitOrder('wallet')">Wallet ·Äñ·Äº·ÄÑ·Ä∑·Ä∫·Äù·Äö·Ä∫</button>
                </div>
            </div>
        </div>

        <div id="topupPage" class="hidden">
            <div class="card">
                <h3>üí∞ Wallet Topup</h3>
                <input type="number" id="tAmt" placeholder="Amount">
                <button class="btn btn-wallet" onclick="submitDeposit()">Submit Request</button>
            </div>
        </div>

        <div id="chatPage" class="hidden">
            <div class="card">
                <h3>üí¨ Chat with Admin</h3>
                <div id="chatBox" class="chat-box"></div>
                <div style="display:flex; gap:5px;">
                    <input type="text" id="userChatInput" placeholder="·ÄÖ·Ä¨·Äõ·Ä±·Ä∏·Äï·Ä´...">
                    <button class="btn btn-direct" style="width:70px;" onclick="sendUserChat()">Send</button>
                </div>
            </div>
        </div>
    </div>

    <div id="botNav" class="bottom-nav hidden">
        <div class="nav-item" id="navShop" onclick="nav('shop', this)">üè†<br>Shop</div>
        <div class="nav-item" id="navTopup" onclick="nav('topup', this)">üí∏<br>Topup</div>
        <div class="nav-item" id="navChat" onclick="nav('chat', this)">üí¨<br>Chat</div>
        <div id="adminTab" class="nav-item hidden" onclick="nav('admin', this)">‚öôÔ∏è<br>Admin</div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCwm2wNMX2u221y2SvxUub1IoFRrTR--88",
        authDomain: "nickgameitems.firebaseapp.com",
        databaseURL: "https://nickgameitems-default-rtdb.firebaseio.com",
        projectId: "nickgameitems",
        storageBucket: "nickgameitems.firebasestorage.app",
        messagingSenderId: "43892922893",
        appId: "1:43892922893:web:23b2ec8e1b16d3d28cd344"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const ADMIN_CREDS = { u: "admin", p: "nickgame" };
    let currentUser = null; let selectedItem = null; let currentAdminChatUser = null;

    function startApp() {
        currentUser = localStorage.getItem('zan_user');
        if(!currentUser) return;
        document.getElementById('authPanel').classList.add('hidden');
        document.getElementById('topNav').classList.remove('hidden');
        document.getElementById('botNav').classList.remove('hidden');
        document.getElementById('userLabel').innerText = "User: " + currentUser;
        loadPrices(); loadBalance();
        if(currentUser === ADMIN_CREDS.u) {
            document.getElementById('adminTab').classList.remove('hidden');
            loadAdminData(); nav('admin', document.getElementById('adminTab'));
        } else {
            loadUserChat(); nav('shop', document.getElementById('navShop'));
        }
    }

    // --- Admin Engine ---
    function loadAdminData() {
        // Deposits
        db.ref('deposits').on('value', s => {
            let h = ""; s.forEach(c => {
                const d = c.val(); if(d.status==='pending') {
                    h += `<div class="card">User: ${d.user} | <b>${d.amount}ks</b> 
                        <button class="btn btn-success" onclick="approveDeposit('${c.key}','${d.user}',${d.amount})">Approve</button></div>`;
                }
            });
            document.getElementById('admDeposits').innerHTML = h || "<p>No pending deposits</p>";
        });
        // Orders
        db.ref('orders').on('value', s => {
            let h = ""; s.forEach(c => {
                const o = c.val(); if(o.status==='pending') {
                    h += `<div class="card"><b>${o.item}</b> (${o.type})<br>ID: ${o.gid} | User: ${o.user}
                        <button class="btn btn-wallet" onclick="db.ref('orders/${c.key}').update({status:'done'})">Done</button></div>`;
                }
            });
            document.getElementById('admOrders').innerHTML = h || "<p>No orders</p>";
        });
        // Chat List
        db.ref('chats').on('value', s => {
            let h = ""; s.forEach(c => {
                h += `<div class="card" onclick="openAdminChat('${c.key}')" style="cursor:pointer;">üí¨ Chat with: <b>${c.key}</b></div>`;
            });
            document.getElementById('admChatList').innerHTML = h || "<p>No chats</p>";
        });
    }

    async function approveDeposit(key, user, amt) {
        const s = await db.ref('users/'+user+'/balance').once('value');
        const cur = s.val() || 0;
        await db.ref('users/'+user).update({ balance: cur + parseInt(amt) });
        await db.ref('deposits/'+key).update({ status: 'approved' });
        alert("Approved!");
    }

    function openAdminChat(user) {
        currentAdminChatUser = user;
        document.getElementById('admChatView').classList.remove('hidden');
        document.getElementById('targetChatUser').innerText = "Chatting with: " + user;
        db.ref('chats/'+user).on('value', s => {
            let h = ""; s.forEach(c => {
                const m = c.val();
                h += `<div class="msg ${m.user==='admin'?'sent':'received'}">${m.text}</div>`;
            });
            document.getElementById('admChatBox').innerHTML = h;
            document.getElementById('admChatBox').scrollTop = document.getElementById('admChatBox').scrollHeight;
        });
    }

    function sendAdminChat() {
        const txt = document.getElementById('admChatInput').value;
        if(txt && currentAdminChatUser) {
            db.ref('chats/'+currentAdminChatUser).push({ user: 'admin', text: txt });
            document.getElementById('admChatInput').value = "";
        }
    }

    function closeAdminChat() { document.getElementById('admChatView').classList.add('hidden'); }

    // --- User Chat ---
    function sendUserChat() {
        const txt = document.getElementById('userChatInput').value;
        if(txt) {
            db.ref('chats/'+currentUser).push({ user: currentUser, text: txt });
            document.getElementById('userChatInput').value = "";
        }
    }

    function loadUserChat() {
        db.ref('chats/'+currentUser).on('value', s => {
            let h = ""; s.forEach(c => {
                const m = c.val();
                h += `<div class="msg ${m.user===currentUser?'sent':'received'}">${m.text}</div>`;
            });
            document.getElementById('chatBox').innerHTML = h;
            document.getElementById('chatBox').scrollTop = document.getElementById('chatBox').scrollHeight;
        });
    }

    // --- Core Functions ---
    async function submitDeposit() {
        const amt = document.getElementById('tAmt').value;
        if(amt) {
            await db.ref('deposits').push({ user: currentUser, amount: amt, status: 'pending' });
            alert("Sent! Admin will check soon.");
        }
    }

    async function submitOrder(type) {
        if(!selectedItem) return alert("Select item");
        const gid = document.getElementById('gameId').value;
        if(!gid) return alert("Enter ID");
        if(type==='wallet') {
            const s = await db.ref('users/'+currentUser+'/balance').once('value');
            if((s.val()||0) < selectedItem.p) return alert("No balance");
            await db.ref('users/'+currentUser).update({ balance: s.val() - selectedItem.p });
        }
        await db.ref('orders').push({ user: currentUser, item: selectedItem.n, gid, type, status:'pending' });
        alert("Ordered!");
    }

    function loadPrices() {
        db.ref('prices').on('value', s => {
            const d = s.val() || {};
            ['weekly','normal','uc_normal'].forEach(c => {
                let h = ""; if(d[c]) Object.keys(d[c]).forEach(k => {
                    const i = d[c][k];
                    h += `<div class="price-item" onclick="select(this,'${i.n}',${i.p})"><b>${i.n}</b><br>${i.p}k</div>`;
                });
                const box = document.getElementById('grid'+c.charAt(0).toUpperCase()+c.slice(1));
                if(box) box.innerHTML = h;
            });
        });
    }

    // Auth & UI Helpers
    function select(el, n, p) { selectedItem = {n, p}; document.querySelectorAll('.price-item').forEach(x => x.classList.remove('selected')); el.classList.add('selected'); document.getElementById('selText').innerText = n + " ("+p+"ks)"; }
    function nav(p, el) { ['shop','topup','chat','admin'].forEach(i => document.getElementById(i+'Page') && document.getElementById(i+'Page').classList.add('hidden')); document.getElementById(p+'Page').classList.remove('hidden'); document.querySelectorAll('.nav-item').forEach(x => x.classList.remove('active')); el.classList.add('active'); }
    function logout() { localStorage.removeItem('zan_user'); location.reload(); }
    async function handleLogin() {
        const u = document.getElementById('lUser').value.trim();
        const p = document.getElementById('lPass').value;
        if(u===ADMIN_CREDS.u && p===ADMIN_CREDS.p) currentUser = u;
        else {
            const s = await db.ref('users/'+u).once('value');
            if(s.exists() && s.val().password === p) currentUser = u;
            else return alert("Failed");
        }
        localStorage.setItem('zan_user', currentUser); startApp();
    }
    async function handleSignUp() {
        const u = document.getElementById('sUser').value.trim();
        const p = document.getElementById('sPass').value;
        if(u && p) { await db.ref('users/'+u).set({ password: p, balance: 0 }); alert("Success"); toggleAuth(false); }
    }
    function toggleAuth(s) { document.getElementById('loginView').classList.toggle('hidden', s); document.getElementById('signView').classList.toggle('hidden', !s); }
    function loadBalance() { db.ref('users/'+currentUser+'/balance').on('value', s => document.getElementById('uBal').innerText = (s.val()||0).toLocaleString()); }
    async function saveItem() {
        const cat = document.getElementById('admCat').value;
        const n = document.getElementById('admItemName').value;
        const p = document.getElementById('admItemPrice').value;
        if(n && p) { await db.ref('prices/'+cat).push({ n, p: parseInt(p) }); alert("Saved"); }
    }
    window.onload = startApp;
</script>
</body>
</html>
